name: Agent Template Compliance Check
description: Ensures all agent files follow strict template format

on:
  push:
    paths:
      - 'agents/**/*.md'
  pull_request:
    paths:
      - 'agents/**/*.md'

jobs:
  validate-templates:
    name: Validate Agent Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install pyyaml click

      - name: Check Template Compliance
        id: compliance
        run: |
          # Use the official Claude Code sub-agent format validator
          # --mode project validates official fields + project extensions (examples, color)
          python tools/validation/validate-agent-official.py agents/ --audit --mode project

      - name: Check for Template Consistency
        if: success()
        run: |
          echo "ðŸŽ¯ Checking template consistency..."
          python << 'EOF'
          import os
          import re
          import yaml
          from collections import Counter

          # Collect all agent metadata
          agents = []
          for root, dirs, files in os.walk('agents'):
              for file in files:
                  if file.endswith('.md'):
                      file_path = os.path.join(root, file)
                      with open(file_path, 'r') as f:
                          content = f.read()

                      yaml_match = re.search(r'^---\s*\n(.*?)\n---', content, re.DOTALL)
                      if yaml_match:
                          try:
                              yaml_content = yaml.safe_load(yaml_match.group(1))
                              agents.append({
                                  'file': file_path,
                                  'name': yaml_content.get('name'),
                                  'color': yaml_content.get('color')
                              })
                          except:
                              pass

          # Check for duplicate names
          names = [a['name'] for a in agents if a['name']]
          name_counts = Counter(names)
          duplicates = [name for name, count in name_counts.items() if count > 1]

          if duplicates:
              print(f"âš ï¸  Warning: Duplicate agent names found:")
              for name in duplicates:
                  print(f"  - {name} (appears {name_counts[name]} times)")

          # Report color distribution
          colors = []
          for a in agents:
              color = a.get('color')
              if color:
                  # Ensure color is a string, not a list or other type
                  if isinstance(color, str):
                      colors.append(color)
                  elif isinstance(color, list) and len(color) > 0:
                      colors.append(color[0])  # Take first color if it's a list
          color_counts = Counter(colors)

          print(f"\nðŸ“Š Agent Statistics:")
          print(f"  Total agents: {len(agents)}")
          print(f"  Unique names: {len(set(names))}")
          print(f"  Color distribution:")
          for color, count in sorted(color_counts.items(), key=lambda x: -x[1]):
              print(f"    - {color}: {count} agents")
          EOF

      - name: Generate Compliance Report
        if: always()
        run: |
          echo "ðŸ“‹ Generating compliance report..."
          python << 'EOF'
          import os
          import json
          from datetime import datetime

          report = {
              'timestamp': datetime.now().isoformat(),
              'status': 'passed' if os.environ.get('GITHUB_JOB_STATUS') != 'failure' else 'failed',
              'files_checked': len([f for r, d, files in os.walk('agents') for f in files if f.endswith('.md')]),
              'workflow_run': os.environ.get('GITHUB_RUN_NUMBER', 'local'),
              'triggered_by': os.environ.get('GITHUB_ACTOR', 'unknown')
          }

          with open('template-compliance-report.json', 'w') as f:
              json.dump(report, f, indent=2)

          print(f"Report saved to template-compliance-report.json")
          EOF

      - name: Upload Compliance Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: template-compliance-report
          path: template-compliance-report.json

  enforce-pr-compliance:
    name: Enforce PR Template Compliance
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: validate-templates
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ Agent Template Compliance Check Failed

              Your PR modifies agent files that don't meet Claude integration requirements.

              **Required YAML Structure:**
              \`\`\`yaml
              ---
              name: agent_name
              description: One-line description
              examples:
              - '<example>
                Context: When to use
                user: "User message"
                assistant: "Response"
                <commentary>Why use this agent</commentary>
              </example>'
              color: color_name
              ---
              \`\`\`

              **Key Requirements:**
              - YAML frontmatter must be at the start of the file
              - All four fields (name, description, examples, color) are required
              - Examples must be a non-empty list
              - Include meaningful content after the YAML (50+ characters)

              **Note:** Additional sections like Team Chemistry, Success Metrics, etc.
              are now ALLOWED. Focus on fixing missing YAML fields and format issues.`
            });

      - name: Success Comment
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âœ… Agent Template Compliance Check Passed

              All agent files meet Claude integration requirements. Excellent work!

              **Billy Wright says:** "Perfect team coordination - agents are ready for Claude integration!"`
            });
